<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <title>ƒê·∫∑t h√†ng</title>
    <style>
        .error {
            color: red;
            margin: 10px 0;
        }

        .success {
            color: green;
            margin: 10px 0;
        }

        .product-list {
            margin: 20px 0;
        }

        .product-item {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 5px 0;
        }

        .user-info {
            text-align: right;
            padding: 10px;
        }

        .form-group {
            margin: 15px 0;
        }

        label {
            display: inline-block;
            width: 200px;
            font-weight: bold;
        }

        input[type="text"] {
            padding: 5px;
        }

        .buttons {
            margin: 20px 0;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- ‚ëß Th√¥ng tin user -->
        <div class="user-info">
            <span th:text="${userInfo}"></span>
            <!-- ‚ë® Button ƒêƒÉng xu·∫•t -->
            <button onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>

        <h2>ƒê·∫∑t h√†ng</h2>

        <!-- Hi·ªÉn th·ªã error message -->
        <div class="error" th:if="${errorMessage}" th:text="${errorMessage}"></div>

        <!-- Hi·ªÉn th·ªã success message -->
        <div class="success" th:if="${successMessage}" th:text="${successMessage}"></div>

        <form id="orderForm" th:action="@{/order/submit}" method="post">

            <!-- ‚ë† Ng∆∞·ªùi ƒë·∫∑t h√†ng -->
            <div class="form-group">
                <label for="customerName">Ng∆∞·ªùi ƒë·∫∑t h√†ng: <span style="color:red">*</span></label>
                <input type="text" id="customerName" name="customerName" maxlength="200" th:value="${customerName}"
                    style="width: 400px;">
            </div>

            <!-- ‚ë° ƒê·ªãa ch·ªâ giao h√†ng -->
            <div class="form-group">
                <label for="deliveryAddress">ƒê·ªãa ch·ªâ giao h√†ng: <span style="color:red">*</span></label>
                <input type="text" id="deliveryAddress" name="deliveryAddress" maxlength="400"
                    th:value="${deliveryAddress}" style="width: 400px;">
            </div>

            <!-- ‚ë¢ Ng√†y giao h√†ng -->
            <div class="form-group">
                <label for="deliveryDate">Ng√†y giao h√†ng (YYYY/MM/DD):</label>
                <input type="text" id="deliveryDate" name="deliveryDate" maxlength="10" th:value="${deliveryDate}"
                    placeholder="YYYY/MM/DD" style="width: 150px;">
            </div>

            <!-- ‚ë£ Danh s√°ch s·∫£n ph·∫©m ƒë·∫∑t h√†ng -->
            <div class="product-list">
                <h3>Danh s√°ch s·∫£n ph·∫©m ƒë·∫∑t h√†ng</h3>
                <div th:if="${orderProducts != null and !orderProducts.empty}">
                    <div class="product-item" th:each="product, iterStat : ${orderProducts}">
                        <input type="hidden" th:name="'products[' + ${iterStat.index} + '].productId'"
                            th:value="${product.productId}">
                        <input type="hidden" th:name="'products[' + ${iterStat.index} + '].productName'"
                            th:value="${product.productName}">
                        <input type="hidden" th:name="'products[' + ${iterStat.index} + '].price'"
                            th:value="${product.price}">

                        <strong th:text="${product.productName}"></strong>
                        <br>
                        <span>Gi√°: </span><span th:text="${product.price}"></span>
                        <span> VND</span>
                        <br>

                        <!-- ‚ë¶ S·ªë l∆∞·ª£ng ƒë·∫∑t h√†ng -->
                        <label>S·ªë l∆∞·ª£ng ƒë·∫∑t h√†ng:</label>
                        <input type="text" th:id="'quantity_' + ${iterStat.index}"
                            th:name="'products[' + ${iterStat.index} + '].orderQuantity'"
                            th:value="${product.orderQuantity}" th:attr="data-product-name=${product.productName},
                                        data-available-quantity=${product.availableQuantity},
                                        data-index=${iterStat.index}" class="quantity-input"
                            onblur="validateQuantity(this)" style="width: 80px;">
                        <span th:text="'(T·ªìn kho: ' + ${product.availableQuantity} + ')'"></span>
                    </div>
                </div>
                <div th:if="${orderProducts == null or orderProducts.empty}">
                    <p>Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ ƒë·∫∑t h√†ng.</p>
                </div>
            </div>

            <!-- ‚ë§‚ë• Buttons -->
            <div class="buttons">
                <button type="submit" name="action" value="order">ƒê·∫∑t h√†ng</button>
                <button type="button" onclick="confirmCancel()">Cancel</button>
            </div>
        </form>
    </div>

    <script th:inline="javascript">
        /*<![CDATA[*/

        // ‚ë¶ Validate s·ªë l∆∞·ª£ng khi lostfocus
        function validateQuantity(input) {
            const value = input.value.trim();
            const productName = input.getAttribute('data-product-name');
            const availableQuantity = parseInt(input.getAttribute('data-available-quantity'));

            // Ki·ªÉm tra r·ªóng
            if (value === '') {
                return; // Cho ph√©p ƒë·ªÉ r·ªóng
            }

            // Ki·ªÉm tra s·ªë nguy√™n
            if (!/^\d+$/.test(value)) {
                alert('S·ªë l∆∞·ª£ng ƒë·∫∑t h√†ng kh√¥ng h·ª£p l·ªá, xin h√£y nh·∫≠p l·∫°i');
                input.focus();
                return;
            }

            const quantity = parseInt(value);

            // Ki·ªÉm tra s·ªë l∆∞·ª£ng t·ªìn kho
            if (quantity > availableQuantity) {
                alert(`S·ªë l∆∞·ª£ng ƒë·∫∑t h√†ng c·ªßa s·∫£n ph·∫©m ${productName} kh√¥ng ƒë·ªß trong kho. Xin h√£y nh·∫≠p s·ªë l∆∞·ª£ng <= ${availableQuantity}`);
                input.focus();
                return;
            }
        }

        // ‚ë• Confirm cancel
        function confirmCancel() {
            if (confirm('B·∫°n c√≥ mu·ªën k·∫øt th√∫c ƒë·∫∑t h√†ng quay tr·ªü v·ªÅ m√†n h√¨nh danh s√°ch s·∫£n ph·∫©m?')) {
                window.location.href = /*[[@{/products/list}]]*/ '/products/list';
            }
        }

        // ‚ë® Logout
        function logout() {
            window.location.href = /*[[@{/logout}]]*/ '/logout';
        }

        // Focus v√†o field b·ªã l·ªói n·∫øu c√≥
        window.onload = function () {
            const focusField = /*[[${focusField}]]*/ '';
            if (focusField) {
                const element = document.getElementById(focusField);
                if (element) {
                    element.focus();
                }
            }
        };

        /*]]>*/
    </script>
</body>

</html>

.button-group {
flex-direction: column;
}

button,
.btn {
width: 100%;
}

table {
font-size: 12px;
}

th,
td {
padding: 8px;
}
}
</style>
</th:block>
</head>

<body>
    <section layout:fragment="content">
        <h1>üõí Trang ƒê·∫∑t H√†ng</h1>

        <!-- Error Messages -->
        <div th:if="${error}" class="alert-error" th:utext="${error}"></div>

        <form id="orderForm" th:action="@{/orders/confirm}" method="post">
            <!-- Hidden fields for search state preservation -->
            <input type="hidden" name="keyword" th:value="${keyword}">
            <input type="hidden" name="producttypeId" th:value="${producttypeId}">
            <input type="hidden" name="page" th:value="${page}">

            <!-- Th√¥ng tin ng∆∞·ªùi ƒë·∫∑t h√†ng -->
            <div class="order-form-container">
                <h2 class="section-title">Th√¥ng tin ng∆∞·ªùi ƒë·∫∑t h√†ng</h2>

                <div class="form-group">
                    <label for="customerName">Ng∆∞·ªùi ƒë·∫∑t h√†ng: <span style="color: red;">*</span></label>
                    <input type="text" id="customerName" name="customerName"
                        th:value="${customerName != null ? customerName : username}" maxlength="200"
                        placeholder="Nh·∫≠p t√™n ng∆∞·ªùi ƒë·∫∑t h√†ng">
                    <div id="customerNameError" class="field-error-message"></div>
                </div>

                <div class="form-group">
                    <label for="deliveryAddress">ƒê·ªãa ch·ªâ giao h√†ng: <span style="color: red;">*</span></label>
                    <input type="text" id="deliveryAddress" name="deliveryAddress" th:value="${deliveryAddress}"
                        maxlength="400" placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ giao h√†ng">
                    <div id="deliveryAddressError" class="field-error-message"></div>
                </div>

                <div class="form-group">
                    <label for="deliveryDate">Ng√†y giao h√†ng (YYYY/MM/DD): <span style="color: red;">*</span></label>
                    <input type="text" id="deliveryDate" name="deliveryDate" th:value="${deliveryDate}" maxlength="10"
                        placeholder="YYYY/MM/DD">
                    <div id="deliveryDateError" class="field-error-message"></div>
                </div>
            </div>

            <!-- Danh s√°ch s·∫£n ph·∫©m -->
            <h2 class="section-title">Danh s√°ch s·∫£n ph·∫©m</h2>
            <table>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>H√¨nh ·∫£nh</th>
                        <th>T√™n s·∫£n ph·∫©m / M√¥ t·∫£</th>
                        <th>Lo·∫°i s·∫£n ph·∫©m</th>
                        <th>S·ªë l∆∞·ª£ng</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:each="item, iterStat : ${orderItems}">
                        <td th:text="${iterStat.index + 1}">1</td>
                        <td>
                            <img th:src="@{'/products/image/' + ${item.productId}}" alt="Product Image"
                                class="product-img" onerror="this.style.display='none'">
                        </td>
                        <td>
                            <div><strong><span th:text="${item.productId}">11010001</span> - <span
                                        th:text="${item.productName}">Product Name</span></strong></div>
                            <div style="font-size: 12px; color: #666;" th:if="${item.productDescription}">
                                <span th:text="${item.productDescription}">Description</span>
                            </div>
                        </td>
                        <td th:text="${item.producttypeName}">Category</td>
                        <td>
                            <input type="number" class="quantity-input" th:name="'quantities'"
                                th:id="'qty_' + ${item.productId}" th:data-product-id="${item.productId}"
                                th:data-product-name="${item.productName}"
                                th:data-available-stock="${item.availableStock}" th:value="${item.quantity}" min="1"
                                onblur="validateQuantity(this)">
                            <input type="hidden" th:name="'productIds'" th:value="${item.productId}">
                            <div th:id="'qtyError_' + ${item.productId}" class="field-error-message"></div>
                        </td>
                    </tr>
                </tbody>
            </table>

            <!-- Buttons -->
            <div class="button-group">
                <button type="button" class="btn btn-confirm" onclick="submitOrder()">ƒê·∫∑t h√†ng</button>
                <button type="button" class="btn btn-cancel" onclick="cancelOrder()">Cancel</button>
            </div>
        </form>

        <script th:inline="javascript">
            const orderItems = /*[[${orderItems}]]*/[];
            const keyword = /*[[${keyword}]]*/ '';
            const producttypeId = /*[[${producttypeId}]]*/ null;
            const page = /*[[${page}]]*/ 1;

            // Validate quantity on blur
            function validateQuantity(input) {
                const productId = input.dataset.productId;
                const productName = input.dataset.productName;
                const availableStock = parseInt(input.dataset.availableStock);
                const quantity = input.value.trim();
                const errorDiv = document.getElementById('qtyError_' + productId);

                // Clear previous error
                errorDiv.classList.remove('show');
                errorDiv.textContent = '';
                input.classList.remove('error');

                // Check if empty
                if (quantity === '') {
                    return;
                }

                // Check if integer
                if (!/^\d+$/.test(quantity)) {
                    errorDiv.textContent = 'S·ªë l∆∞·ª£ng ƒë·∫∑t h√†ng kh√¥ng h·ª£p l·ªá, xin h√£y nh·∫≠p l·∫°i';
                    errorDiv.classList.add('show');
                    input.classList.add('error');
                    input.focus();
                    return false;
                }

                const qtyValue = parseInt(quantity);

                // Check if positive
                if (qtyValue <= 0) {
                    errorDiv.textContent = 'S·ªë l∆∞·ª£ng ƒë·∫∑t h√†ng kh√¥ng h·ª£p l·ªá, xin h√£y nh·∫≠p l·∫°i';
                    errorDiv.classList.add('show');
                    input.classList.add('error');
                    input.focus();
                    return false;
                }

                // Check against available stock
                if (qtyValue > availableStock) {
                    errorDiv.textContent = `S·ªë l∆∞·ª£ng ƒë·∫∑t h√†ng c·ªßa s·∫£n ph·∫©m ${productName} kh√¥ng ƒë·ªß trong kho. Xin h√£y nh·∫≠p s·ªë l∆∞·ª£ng <= ${availableStock}`;
                    errorDiv.classList.add('show');
                    input.classList.add('error');
                    input.focus();
                    return false;
                }

                return true;
            }

            // Validate date format and value
            function validateDate(dateString) {
                // Check format YYYY/MM/DD
                const datePattern = /^(\d{4})\/(\d{2})\/(\d{2})$/;
                const match = dateString.match(datePattern);

                if (!match) {
                    return { valid: false, message: 'Ng√†y giao h√†ng kh√¥ng h·ª£p l·ªá, xin h√£y nh·∫≠p l·∫°i' };
                }

                const year = parseInt(match[1]);
                const month = parseInt(match[2]);
                const day = parseInt(match[3]);

                // Check valid date
                const date = new Date(year, month - 1, day);
                if (date.getFullYear() !== year || date.getMonth() !== month - 1 || date.getDate() !== day) {
                    return { valid: false, message: 'Ng√†y giao h√†ng kh√¥ng h·ª£p l·ªá, xin h√£y nh·∫≠p l·∫°i' };
                }

                // Check if date is not in the past
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                date.setHours(0, 0, 0, 0);

                if (date < today) {
                    return { valid: false, message: 'Ng√†y giao h√†ng kh√¥ng h·ª£p l·ªá, xin h√£y nh·∫≠p l·∫°i' };
                }

                return { valid: true };
            }

            // Submit order
            function submitOrder() {
                let isValid = true;
                let firstErrorField = null;

                // Clear all errors
                document.querySelectorAll('.error-message').forEach(el => {
                    el.classList.remove('show');
                    el.textContent = '';
                });
                document.querySelectorAll('input').forEach(el => {
                    el.classList.remove('error');
                });

                // Validate customer name
                const customerName = document.getElementById('customerName').value.trim();
                if (!customerName) {
                    const errorDiv = document.getElementById('customerNameError');
                    errorDiv.textContent = 'Xin h√£y nh·∫≠p th√¥ng tin ng∆∞·ªùi ƒë·∫∑t h√†ng';
                    errorDiv.classList.add('show');
                    document.getElementById('customerName').classList.add('error');
                    if (!firstErrorField) firstErrorField = document.getElementById('customerName');
                    isValid = false;
                }

                // Validate delivery address
                const deliveryAddress = document.getElementById('deliveryAddress').value.trim();
                if (!deliveryAddress) {
                    const errorDiv = document.getElementById('deliveryAddressError');
                    errorDiv.textContent = 'Xin h√£y nh·∫≠p th√¥ng tin ƒë·ªãa ch·ªâ giao h√†ng';
                    errorDiv.classList.add('show');
                    document.getElementById('deliveryAddress').classList.add('error');
                    if (!firstErrorField) firstErrorField = document.getElementById('deliveryAddress');
                    isValid = false;
                }

                // Validate delivery date
                const deliveryDate = document.getElementById('deliveryDate').value.trim();
                if (!deliveryDate) {
                    const errorDiv = document.getElementById('deliveryDateError');
                    errorDiv.textContent = 'Ng√†y giao h√†ng kh√¥ng h·ª£p l·ªá, xin h√£y nh·∫≠p l·∫°i';
                    errorDiv.classList.add('show');
                    document.getElementById('deliveryDate').classList.add('error');
                    if (!firstErrorField) firstErrorField = document.getElementById('deliveryDate');
                    isValid = false;
                } else {
                    const dateValidation = validateDate(deliveryDate);
                    if (!dateValidation.valid) {
                        const errorDiv = document.getElementById('deliveryDateError');
                        errorDiv.textContent = dateValidation.message;
                        errorDiv.classList.add('show');
                        document.getElementById('deliveryDate').classList.add('error');
                        if (!firstErrorField) firstErrorField = document.getElementById('deliveryDate');
                        isValid = false;
                    }
                }

                // Validate quantities
                const invalidProducts = [];
                document.querySelectorAll('.quantity-input').forEach(input => {
                    const productId = input.dataset.productId;
                    const productName = input.dataset.productName;
                    const availableStock = parseInt(input.dataset.availableStock);
                    const quantity = input.value.trim();

                    if (quantity) {
                        if (!/^\d+$/.test(quantity) || parseInt(quantity) <= 0) {
                            const errorDiv = document.getElementById('qtyError_' + productId);
                            errorDiv.textContent = 'S·ªë l∆∞·ª£ng ƒë·∫∑t h√†ng kh√¥ng h·ª£p l·ªá, xin h√£y nh·∫≠p l·∫°i';
                            errorDiv.classList.add('show');
                            input.classList.add('error');
                            if (!firstErrorField) firstErrorField = input;
                            isValid = false;
                        } else if (parseInt(quantity) > availableStock) {
                            invalidProducts.push({
                                name: productName,
                                stock: availableStock,
                                input: input
                            });
                        }
                    }
                });

                // Handle invalid stock quantities
                if (invalidProducts.length > 0) {
                    if (invalidProducts.length === 1) {
                        const product = invalidProducts[0];
                        const errorDiv = document.getElementById('qtyError_' + product.input.dataset.productId);
                        errorDiv.textContent = `S·ªë l∆∞·ª£ng ƒë·∫∑t h√†ng c·ªßa s·∫£n ph·∫©m ${product.name} kh√¥ng ƒë·ªß trong kho. Xin h√£y nh·∫≠p s·ªë l∆∞·ª£ng <= ${product.stock}`;
                        errorDiv.classList.add('show');
                        product.input.classList.add('error');
                        if (!firstErrorField) firstErrorField = product.input;
                    } else {
                        let message = 'D∆∞·ªõi ƒë√¢y c√°c s·∫£n ph·∫©m m√† s·ªë l∆∞·ª£ng ƒë·∫∑t h√†ng l·ªõn h∆°n s·ªë l∆∞·ª£ng trong kho. Xin h√£y nh·∫≠p l·∫°i s·ªë l∆∞·ª£ng\\n';
                        invalidProducts.forEach(product => {
                            message += `\\nS·∫£n ph·∫©m ${product.name} c√≥ s·ªë l∆∞·ª£ng t·ªìn kho ${product.stock}`;
                            const errorDiv = document.getElementById('qtyError_' + product.input.dataset.productId);
                            errorDiv.textContent = `S·ªë l∆∞·ª£ng t·ªìn kho: ${product.stock}`;
                            errorDiv.classList.add('show');
                            product.input.classList.add('error');
                        });
                        alert(message);
                        if (!firstErrorField) firstErrorField = invalidProducts[0].input;
                    }
                    isValid = false;
                }

                if (!isValid) {
                    if (firstErrorField) {
                        firstErrorField.focus();
                    }
                    return;
                }

                // If all validations pass, submit the form
                document.getElementById('orderForm').submit();
            }

            // Cancel order
            function cancelOrder() {
                if (!confirm('B·∫°n c√≥ mu·ªën k·∫øt th√∫c ƒë·∫∑t h√†ng quay tr·ªü v·ªÅ m√†n h√¨nh danh s√°ch s·∫£n ph·∫©m?')) {
                    return;
                }

                let url = '/products/list?';
                if (keyword) {
                    url += 'keyword=' + encodeURIComponent(keyword) + '&';
                }
                if (producttypeId) {
                    url += 'producttypeId=' + producttypeId + '&';
                }
                url += 'page=' + page;

                // Add quantities to restore
                document.querySelectorAll('.quantity-input').forEach(input => {
                    const productId = input.dataset.productId;
                    const quantity = input.value.trim();
                    if (quantity) {
                        url += '&qty_' + productId + '=' + quantity;
                    }
                });

                window.location.href = url;
            }
        </script>
    </section>
</body>

</html>